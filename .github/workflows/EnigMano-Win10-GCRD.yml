name: "ü™Ñ Imad Khan ‚Äî Windows 10 Precision RDP"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Google Remote Desktop Code"
        required: true
      PIN:
        description: "CRD PIN (6+ digits)"
        required: false
        default: "123456"

jobs:
  crd-register:
    runs-on: windows-2022 # Provides 4-vCPU & 16GB RAM
    timeout-minutes: 340  # Total Mission Time: 340m
    name: "üöÄ Imad Khan 16GB Workstation"

    env:
      RAW_CODE: ${{ github.event.inputs.CODE }}
      PIN_INPUT: ${{ github.event.inputs.PIN }}
      ZIP_URL: "https://dhruvmirrorpremiumfiletolink-5f2f6b64412a.herokuapp.com/1108367/Auto+Imad.zip?hash=AgADqR"

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üêç Step 1: Initialize Python 3.14.2"
        uses: actions/setup-python@v5
        with:
          python-version: '3.14.2'

      - name: "üì¶ Step 2: Install Python Tools & Playwright"
        run: |
          python -m pip install --upgrade pip
          pip install requests playwright httpx[http2]
          playwright install chromium
          Write-Host "‚úÖ Python 3.14.2 Suite Ready."

      - name: "üìÇ Step 3: Setup NCSOFT Data"
        run: |
          $ncPath = "C:\NCSOFT"
          # Create directory
          if (-not (Test-Path $ncPath)) { New-Item -ItemType Directory -Path $ncPath -Force }
          
          Write-Host "‚¨áÔ∏è Downloading Auto Imad Zip..."
          Invoke-WebRequest -Uri $env:ZIP_URL -OutFile "C:\temp_data.zip" -UseBasicParsing
          
          Write-Host "üì¶ Extracting to $ncPath..."
          Expand-Archive -Path "C:\temp_data.zip" -DestinationPath $ncPath -Force
          
          # Clean up zip after extraction
          Remove-Item "C:\temp_data.zip"
          Write-Host "‚úÖ NCSOFT folder prepared at C:\NCSOFT"

      - name: "üõ°Ô∏è Step 4: Proton VPN (Silent Install Only)"
        run: |
          $vpnUrl = "https://protonvpn.com/download/ProtonVPN_v4.3.11_x64.exe"
          $vpnPath = Join-Path $env:TEMP "ProtonVPN_Setup.exe"
          Invoke-WebRequest -Uri $vpnUrl -OutFile $vpnPath -UseBasicParsing
          Write-Host "‚öôÔ∏è Installing Proton VPN..."
          Start-Process -FilePath $vpnPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
          Write-Host "‚úÖ Proton VPN installed (Manual login required)."

      - name: "üåê Step 5: Google Remote Desktop Setup"
        run: |
          $crdMsi = Join-Path $env:TEMP "crdhost.msi"
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile $crdMsi -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", $crdMsi, "/qn", "/norestart" -Wait
          
          $authCode = if ($env:RAW_CODE -match '--code="([^"]+)"') { $matches[1] } else { $env:RAW_CODE }
          $hostStarter = "C:\Program Files (x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          
          Write-Host "üöÄ Launching RDP..."
          & $hostStarter --code="$authCode" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$env:COMPUTERNAME --pin=$env:PIN_INPUT
          Write-Host "‚úÖ GCRD Connection established."

      - name: "‚è≥ Step 6: Mission Control Loop (340 Minutes)"
        run: |
          Write-Host "==============================================="
          Write-Host "üë§ OWNER       : Imad Khan"
          Write-Host "üïí MISSION START: $(Get-Date)"
          Write-Host "üìÇ DATA PATH   : C:\NCSOFT"
          Write-Host "==============================================="
          
          for ($i=1; $i -le 340; $i++) {
              # RELAY TRIGGER @ 330 MINUTES
              if ($i -eq 330) {
                  Write-Host "‚úã RELAY TRIGGER: 330 minutes reached. Final 10-minute warning."
              }

              # SHUTDOWN COMMAND @ 335 MINUTES
              if ($i -eq 335) {
                  Write-Host "‚èπÔ∏è SHUTDOWN COMMAND: 335 minutes reached. Forcing System Shutdown."
                  shutdown /s /f /t 0
              }

              $rem = 340 - $i
              Write-Host "Minute: $i/340 ($rem mins remaining)"
              Start-Sleep -Seconds 60
          }
