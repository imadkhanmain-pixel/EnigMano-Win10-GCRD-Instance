name: "‚ö° EnigMano ‚Äî GCRD Automation"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Full headless command or just the 4/... token from https://remotedesktop.google.com/headless (Windows)."
        required: true
      PIN:
        description: "CRD PIN (6+ digits). Default 123456"
        required: false
        default: "123456"
      RETRIES:
        description: "Retries for start-host (default 3)"
        required: false
        default: "3"

permissions:
  contents: read

concurrency:
  group: crd-register-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  crd-register:
    name: "ü™Ñ EnigMano Windows 10"
    runs-on: windows-2022

    env:
      RAW_CODE:      ${{ github.event.inputs.CODE }}
      PIN_INPUT:     ${{ github.event.inputs.PIN }}
      RETRIES_INPUT: ${{ github.event.inputs.RETRIES }}
      BRANCH:        ${{ github.ref_name }}
      RUNNER_ENV:    "hosted"
      EnigMano_Access_Token: ${{ secrets.EnigMano_Access_Token }}
      # Target Python Path
      TARGET_PY: "C:\hostedtoolcache\windows\Python\3.14.2\x64"

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üêç Force Python 3.14.2 & Purge Others"
        run: |
          Write-Host "Checking for Python 3.14.2 at $env:TARGET_PY..."
          
          if (Test-Path $env:TARGET_PY) {
              # 1. Remove all existing Python entries from the current session path
              $CurrentPath = $env:PATH -split ';'
              $CleanedPath = ($CurrentPath | Where-Object { $_ -notmatch 'Python' }) -join ';'
              $env:PATH = "$env:TARGET_PY;$env:TARGET_PY\Scripts;$CleanedPath"
              
              # 2. Update GITHUB_PATH so all following steps use 3.14.2
              # We put it at the top so it takes priority over system defaults
              echo "$env:TARGET_PY" >> $env:GITHUB_PATH
              echo "$env:TARGET_PY\Scripts" >> $env:GITHUB_PATH
              
              Write-Host "‚úÖ Path updated. Current Version:"
              python --version
          } else {
              Write-Error "‚ùå Python 3.14.2 not found at $env:TARGET_PY."
              Write-Host "Available versions in cache:"
              Get-ChildItem "C:\hostedtoolcache\windows\Python\" | Select-Object Name
              exit 1
          }

      - name: "üîß Environment Summary & Preload"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          
          Write-Host "==============================================="
          Write-Host "üíª OS Version        : $env:ImageOS"
          Write-Host "üêç Active Python     : $(python --version)"
          Write-Host "üß† Runner Machine    : $env:RUNNER_NAME"
          Write-Host "üåø Branch/Ref        : $env:BRANCH"
          Write-Host "==============================================="

          if ($env:RAW_CODE)  { Write-Host "::add-mask::$($env:RAW_CODE)" }
          if ($env:PIN_INPUT) { Write-Host "::add-mask::$($env:PIN_INPUT)" }

          if (-not $env:EnigMano_Access_Token) {
            Write-Error "‚ùå Missing required repository secret: EnigMano_Access_Token"
            exit 1
          }

          $userDownloads = Join-Path $env:USERPROFILE 'Downloads'
          if (-not (Test-Path $userDownloads)) { New-Item -ItemType Directory -Path $userDownloads | Out-Null }

          $headers = @{
              "User-Agent" = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          }

          $assets = @(
            @{ Url = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"; Name = "crdhost.msi" },
            @{ Url = "https://downloads.cloudflareclient.com/v1/download/windows/ga"; Name = "Cloudflare_WARP_x64.msi" },
            @{ Url = "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64-user"; Name = "VisualStudio.exe" },
            @{ Url = "https://nodejs.org/dist/v24.11.0/node-v24.11.0-x64.msi"; Name = "node-v24.msi" }
          )

          foreach ($a in $assets) {
            $dest = Join-Path $userDownloads $a.Name
            Write-Host "‚¨áÔ∏è Downloading $($a.Name)..."
            Invoke-WebRequest -Uri $a.Url -OutFile $dest -Headers $headers -UseBasicParsing -TimeoutSec 120
          }

      - name: "üåü EnigMano Magical Setup & Execution"
        run: |
          $scriptName = "EnigMano-GCRD-Instance.ps1"
          $url = "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/EnigMano-GCRD-Instance.ps1"
          
          Write-Host "‚¨áÔ∏è Downloading script..."
          Invoke-WebRequest -Uri $url -OutFile $scriptName -UseBasicParsing -TimeoutSec 120

          Write-Host "ü©π Patching script to ignore audio errors..."
          $content = Get-Content $scriptName -Raw
          $content = $content -replace 'Fail "Phase Audio', 'Write-Warning "‚ö†Ô∏è Skipped Audio (Patched by Workflow)'
          Set-Content -Path $scriptName -Value $content

          Write-Host "üöÄ Executing with Python $(python --version)..."
          powershell.exe -ExecutionPolicy Bypass -File ".\$scriptName" `
            -Code ($env:RAW_CODE) `
            -Pin ($env:PIN_INPUT) `
            -Retries ($env:RETRIES_INPUT) `
            -GateSecret ($env:EnigMano_Access_Token)
