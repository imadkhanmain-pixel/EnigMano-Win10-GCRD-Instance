name: "‚ö° EnigMano ‚Äî Full Optimized (5h 50m)"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Google Remote Desktop Code"
        required: true
      PIN:
        description: "CRD PIN (6+ digits)"
        required: false
        default: "123456"

jobs:
  crd-register:
    runs-on: windows-2022
    name: "ü™Ñ EnigMano Windows 10"

    env:
      RAW_CODE: ${{ github.event.inputs.CODE }}
      PIN_INPUT: ${{ github.event.inputs.PIN }}
      EnigMano_Access_Token: ${{ secrets.EnigMano_Access_Token }}
      PY_EXE: "C:\\hostedtoolcache\\windows\\Python\\3.14.2\\x64\\python.exe"
      PROTON_URL: "https://protonvpn.com/download/ProtonVPN_v4.3.11_x64.exe"

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üêç Step 1: Force Python 3.14.2 & System Path"
        run: |
          if (Test-Path $env:PY_EXE) {
              $pyDir = Split-Path $env:PY_EXE
              # Apply to current runner session
              $CleanedPath = ($env:PATH -split ';' | Where-Object { $_ -notmatch 'Python' }) -join ';'
              $env:PATH = "$pyDir;$pyDir\Scripts;$CleanedPath"
              
              # Apply to all future GitHub steps
              echo "$pyDir" >> $env:GITHUB_PATH
              echo "$pyDir\Scripts" >> $env:GITHUB_PATH
              
              # PERMANENT FIX: Set for the User Profile (so it works when you RDP in)
              [Environment]::SetEnvironmentVariable("Path", "$pyDir;$pyDir\Scripts;" + [Environment]::GetEnvironmentVariable("Path", "User"), "User")
              Write-Host "‚úÖ Python 3.14.2 path set for both Runner and RDP User."
          }

      - name: "üì¶ Step 2: Install Python Tools & VPN (Parallel)"
        run: |
          # Start VPN download in background
          $vpnPath = Join-Path $env:TEMP "ProtonVPN_Setup.exe"
          $job = Start-Job -ScriptBlock { 
              param($url, $path) 
              Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing 
          } -ArgumentList $env:PROTON_URL, $vpnPath

          # Install Python Packages specifically to 3.14.2
          & $env:PY_EXE -m pip install --upgrade pip
          & $env:PY_EXE -m pip install requests playwright httpx[http2]
          & $env:PY_EXE -m playwright install chromium

          # Complete VPN install
          Wait-Job $job | Out-Null
          Start-Process -FilePath $vpnPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
          Write-Host "‚úÖ Environment & VPN Ready."

      - name: "üåê Step 3: GCRD Launch & Keep-Alive"
        run: |
          # 1. Download CRD Installer
          $dest = Join-Path $env:USERPROFILE 'Downloads\crdhost.msi'
          if (-not (Test-Path (Split-Path $dest))) { New-Item -ItemType Directory -Path (Split-Path $dest) | Out-Null }
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile $dest -UseBasicParsing
          
          # 2. Download and Multi-Patch Script
          $scriptName = "EnigMano-GCRD-Instance.ps1"
          Invoke-WebRequest -Uri "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/EnigMano-GCRD-Instance.ps1" -OutFile $scriptName -UseBasicParsing
          
          $content = Get-Content $scriptName -Raw
          $content = $content -replace 'Fail "Phase Audio', 'Write-Warning "‚ö†Ô∏è Audio Skipped'
          $content = $content -replace 'Fail "Phase WARP', 'Write-Warning "‚ö†Ô∏è WARP Skipped'
          $content = $content -replace 'Fail "Phase Node', 'Write-Warning "‚ö†Ô∏è Node Skipped'
          $content = $content -replace 'Fail "Phase Visual', 'Write-Warning "‚ö†Ô∏è VSCode Skipped'
          Set-Content -Path $scriptName -Value $content

          # 3. Start Host
          Write-Host "üöÄ Launching GCRD..."
          powershell.exe -ExecutionPolicy Bypass -File ".\$scriptName" `
            -Code ($env:RAW_CODE) -Pin ($env:PIN_INPUT) -GateSecret ($env:EnigMano_Access_Token)

          # 4. Keep-Alive Loop (350 Minutes)
          Write-Host "‚è≥ Session active for 5h 50m. Connect via Google Remote Desktop now!"
          for ($i=1; $i -le 350; $i++) {
              Start-Sleep -Seconds 60
          }
